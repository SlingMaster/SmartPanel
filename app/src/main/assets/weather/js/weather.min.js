/*! (c) Developer Alex Dovby 
weather Release It is Created 01.11.2020 - 13:58:29,66 
version 01.11.2020 */
;var BULL="&#8226;";var BULL_SP=" &#8226; ";var SPLASH_SHOW_DELAY=2000;var CONTENT_PATCH="img/";var MAP_ICON_PATCH="img/map_icon/";var EVT_NIGHT_MODE=201;var intervalID;var FLAKE_MAX_SIZE=1.5;var T_CORRECTION=3000;function setEnvironment(){var e=800;var d=220;var b=0;var a=0;var c="4s";switch(cloudiness){case -1:a=0.25;break;case 0:a=0;break;case 1:a=0.25;break;case 2:a=0.35;break;case 3:a=0.5;break}if(tod_visual===0){a=1;e=920;d=20;c="5s";b=cloudiness===0?1:0}if(tod_visual===1){d=25;e=920;b=0;c="1s"}if(tod_visual===3){e=900;d=25;b=cloudiness===0?1:0}if(tod_visual===0){$("#nature").css("opacity",0.25)}else{$("#nature").css("opacity",1)}$("#gosprom_night").css("opacity",a);$(".moon").css({top:d,left:e,opacity:b,transitionDuration:c});updateSky()}function updateSky(){var b="sky";var a=1;switch(cloudiness){case -1:b=tod_visual===3?"sky-light-sunset-cloud":tod_visual===0?season===0||season===3?"sky-overcast2":"sky-overcast":"sky-light-cloud";a=tod_visual===0?0.4:1;break;case 0:b=tod_visual===3?"sky-sunset":tod_visual===0?"sky-night":"sky";break;case 1:b=tod_visual===3?"sky-light-sunset-cloud":"sky-light-cloud";break;case 2:b="sky-cloudy";break;case 3:b=season===0||season===3?"sky-overcast2":"sky-overcast";a=tod_visual==0?0.2:1;break}if(thunderstorm){b="sky-overcast"}$("#sky-cur").fadeIn(0);$(".moon").toggleClass("night",tod_visual===0);$("#sky").css("opacity",a);$("#sky").css("backgroundImage","url(weather/img/"+b+".jpg)");$("#flash").css("display",thunderstorm?"block":"none");$(".visual_corection").fadeOut("slow",function(){if(tod_visual===0){$(".visual_corection").toggleClass("sky_spring",false);$(".visual_corection").toggleClass("sky_summer",false);$(".visual_corection").toggleClass("sky_autom",false);$(".visual_corection").toggleClass("sky_night",(tod_visual===0||cloudiness===-1)&&cloudiness!==0&&cloudiness<3)}else{$(".visual_corection").toggleClass("sky_night",false);$(".visual_corection").toggleClass("sky_spring",season===1&&cloudiness<3);$(".visual_corection").toggleClass("sky_summer",season===2&&cloudiness<3);$(".visual_corection").toggleClass("sky_autom",season===3&&cloudiness<3)}$("#sky-cur").fadeOut("slow",function(){$("#sky-cur").css("backgroundImage","url(weather/img/"+b+".jpg)");$(".visual_corection").fadeIn(T_CORRECTION);$("#sky-cur").css("opacity",a);$})});if(cloudiness===-1){$(".fog").fadeIn("slow")}else{$(".fog").fadeOut("slow")}}var flakes=[],flakeCount=75,mX=-100,mY=-100;function snowfall(){var k=(precipitation===6||precipitation===3)?0:75;for(var d=0;d<flakeCount+k;d++){var e=flakes[d],l=mX,h=mY,m=150,b=e.x,j=e.y;var g=Math.sqrt((b-l)*(b-l)+(j-h)*(j-h));if(g<m){var c=m/(g*g),a=(l-b)/g,n=(h-j)/g,f=c/2;e.velX-=f*a;e.velY-=f*n}else{e.velX*=0.98;if(e.velY<=e.speed){e.velY=e.speed}e.velX+=Math.cos((e.step+=0.05))*e.stepSize}ctx.fillStyle="rgba(255,255,255,"+e.opacity+")";e.y+=e.velY;e.x+=e.velX;if(e.y>=canvas.height||e.y<=0){reset(e)}if(e.x>=canvas.width||e.x<=0){reset(e)}ctx.beginPath();ctx.arc(e.x,e.y,e.size,0,Math.PI*2);ctx.fill()}}function reset(a){a.x=Math.floor(Math.random()*canvas.width);a.y=0;a.size=Math.random()*FLAKE_MAX_SIZE+1;a.speed=Math.random()*1+0.5;a.velY=a.speed;a.velX=0;a.opacity=a.size<=2?0.75:1}function initSnow(){var b=(precipitation===6||precipitation===3)?0:75;for(var d=0;d<flakeCount+b;d++){var a=Math.floor(Math.random()*canvas.width),f=Math.floor(Math.random()*canvas.height),c=Math.random()*FLAKE_MAX_SIZE+0.5,e=Math.random()*((precipitation===3?10:1)+0.5);flakes.push({opacity:c<=2?0.75:1,speed:e,velY:e,velX:0,x:a,y:f,size:c,stepSize:Math.random()/(precipitation===3?100:30),step:0})}}function initRain(){var l=canvas.width;var g=canvas.height;ctx.strokeStyle="rgba(174,194,224,0.5)";ctx.lineWidth=0.5;var m=[];var c=(precipitation===4||precipitation===3)?200:300;var d=(precipitation===4||precipitation===3)?1.25:2.5;var f=(precipitation===4||precipitation===3)?0:-4;for(var k=0;k<c;k++){m.push({x:Math.random()*l,y:Math.random()*g,l:Math.random()*d,xs:f+Math.random()*2,ys:Math.random()*5+10})}var n=[];for(var i=0;i<c;i++){ctx.lineWidth=1;n[i]=m[i]}j();function j(){for(var b=0;b<n.length;b++){var a=n[b];ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(a.x+a.l*a.xs,a.y+a.l*a.ys);ctx.stroke()}}function e(){for(var a=0;a<n.length;a++){var h=n[a];h.x+=h.xs;h.y+=h.ys;if(h.x>l||h.y>g){h.x=Math.random()*l;h.y=-20}}}}function getWeatherOutDoor(){$("#sync").fadeIn(0);setTimeout(function(){sendCommandESP("web_srv",WEB_URL,"update",0)},800)}function updateWeatherOutDoor(b){var a=b.air_t;$("#t").html((a>=0?"+":"")+parseFloat(a).toFixed(1)+"°");$("#t").toggleClass("cool",a<0);$(".desc_presure").html(parseFloat(b.air_p).toFixed(0)+" mm Hq");$(".desc_humidity").html(parseFloat(b.air_h).toFixed(1)+"%");$("#sync").fadeOut("slow")}var MONTH=["January","February","March","April","May","June","July","August","September","October","November","December"];var WEEKDAY=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var start_day;var start_night;var auto_start_night_mode;var swap_frequency;var nightMode=false;var last_state=true;var seasonTimer;var fast_time=false;var TODS=["Night"," Morning","Day","Evening"];var FPS=24;var WEB_URL;var DEBUG=false;var withAPP=false;var precipitation=0;var cloudiness=0;var thunderstorm=false;var snow=false;var rain=false;var season=0;var canvas,ctx;var curMonth=0;var tod_visual=0;var animationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1000/FPS)};window.onload=function(){if(!isTouchDevice()){init({})}withAPP=isNativeApplication();createUI();canvas=document.getElementById("canvas");ctx=canvas.getContext("2d");addOnmessageEventsListener();addCrossdomainEventsListener();window.setTimeout(function(){sendRequestToNativeApp(EVT_READY,{browser:getBrowser(),ui:"project_weather"});$(".overlay").fadeOut("slow",function(){console.info("load main");setInterval(DateTime,60000);window.requestAnimationFrame=animationFrame;console.info("next initSnow()");initSnow();console.info("next loop()");loop()})},2500)};function createUI(){var a='<div class="panorama"><div id="sky-box"><div id="sky" class="sky"></div><div id="flash" class="sky-storm lightning flashit"></div><div id="sky-cur" class="sky-cur"></div><div class="visual_corection"></div><div class="stars"><div class="moon"></div></div></div><div class="gosprom"></div><div id="gosprom_night" class="gosprom-night"><div class="win_light" style="left:319px; top:280px; animation-duration:110s; -webkit-animation-duration:110s;"/><div class="win_light" style="left:273px; top:300px; animation-duration:17s; -webkit-animation-duration:17s;"/><div class="win_light" style="left:356px; top:372px; animation-duration:117s; -webkit-animation-duration:117s;"/><div class="win_light" style="left:447px; top:373px; animation-duration:128s; -webkit-animation-duration:128s;"/><div class="win_light" style="left:366px; top:352px; animation-duration:123s; -webkit-animation-duration:123s;"></div><div class="win_light" style="left:376px; top:352px; animation-duration:123s; -webkit-animation-duration:123s;"></div><div class="win_light" style="left:366px; top:393px; animation-duration:111s; -webkit-animation-duration:111s;"></div><div class="win_light" style="left:598px; top:282px; animation-duration:130s; -webkit-animation-duration:130s;"/><div class="win_light" style="left:553px; top:305px; animation-duration:122s; -webkit-animation-duration:122s;"/><div class="win_light" style="left:631px; top:365px; animation-duration:145s; -webkit-animation-duration:145s;"/></div><div class="warning-light"></div><div class="warning-light clon"></div><div id="nature" class="nature"></div><div class="fog"></div><canvas id="canvas" class="canvas" width="640" height="170"></canvas></div><div class="content_box" onclick="clickToggleForecast(event);"><div><span id="location"></span><span id="cur_date" class="cur_date" onclick="clickRunSeasonScript(event);"></span></div><div><span id="t" class="big_font"></span><span class="rose_wind"><div class="wind_arrow"></div></span><span class="desc_outdor"><div class="desc_humidity"></div><div class="desc_presure"></div></span></div><div class="forecast">•</div></div><div id="forecast" class="forecast_box" onclick="clickToggleForecast(event);"><div class="spinner wf"></div></div>';$("#content").html(a);DateTime()}function setCurrentSeason(a){console.info("curMonth : "+a);if(a===11||a<2){season=0}else{if(a>1&&a<5){season=1}else{if(a>4&&a<8){season=2}else{if(a>7&&a<12){season=3}}}}}function DateTime(){if(fast_time){return}var c=new Date();var a=c.getHours();var b=c.getMinutes();curMonth=c.getMonth();tod_visual=getTodVisual();setCurrentSeason(curMonth);$("#location").html('<div id="sync" class="spinner"></div><div class="time">'+formatXX(a,2)+":"+formatXX(c.getMinutes(),2)+" • KHARKIV</div>");$("#cur_date").html(c.getDate()+", "+MONTH[curMonth]+" • "+WEEKDAY[c.getDay()]+" • "+c.getFullYear());getWeatherOutDoor();if(a===(start_day+1)&&b===30){sendRequestToNativeApp(EVT_SHOW_TIME,{response:null})}}function loop(){if(rain||snow){ctx.clearRect(0,0,canvas.width,canvas.height);if(snow){snowfall()}if(rain){initRain()}}animationFrame(loop)}function JavaScriptCallback(c,b){console.info("[] JavaScriptCallback cmd = "+c+" | data = "+JSON.stringify(b));var a=b[RESPONSE_JSON]||{};$("#cmd").html(c);switch(c){case CMD_INIT:init(a);break;case CMD_BACK:break;case CMD_WEATHER_DATA:forecastWeather(a);break;case CMD_SWAP:toggleForecast();break;case CMD_SEASON_MAGIC:runSeasonScript();break;default:console.info("[] JavaScriptCallback command "+c+" not present");break}}function forecastWeather(b){var a=b.MMWEATHER.REPORT.TOWN.FORECAST[1]||{};var g="N/A";var e=0;var f=new Date();if(isDefined(a)){precipitation=a.PHENOMENA.precipitation||9;snow=precipitation===3||precipitation===6||precipitation===7;rain=precipitation===3||precipitation===4||precipitation===5;thunderstorm=precipitation===8||a.PHENOMENA.spower===1||0;e=45*(a.WIND.direction||0);cloudiness=a.PHENOMENA.cloudiness;var c=a.TEMPERATURE.max;g="Forecast for "+TODS[a.tod||0]+'&nbsp;&nbsp;•&nbsp;&nbsp;<span class="ic pressure">&nbsp;</span>Presure • '+a.PRESSURE.max+' mmHq <span class="ic '+(c>=0?"temperature":"temperature_min")+'">&nbsp;</span>Temperature • '+a.TEMPERATURE.max+'°C <span class="ic humidity">&nbsp;</span>Humidity • '+a.RELWET.max+' % <span class="ic wind">&nbsp;</span>Wind • '+a.WIND.min+"-"+a.WIND.max+' m/s <span class="ic heat">&nbsp;</span>Heat • '+a.HEAT.min+'°C<span class="ic sync">&nbsp;</span>Last Sync • '+formatXX(f.getHours(),2)+":"+formatXX(f.getMinutes(),2)}$(".forecast").html(g);$(".wind_arrow").css({WebkitTransform:"rotate("+e+"deg)"});$("#canvas").toggleClass("show",snow||rain);updateUI();if($("#forecast").hasClass("show")){createForecast(b.MMWEATHER.REPORT.TOWN.FORECAST||[])}}function setSeason(){var a=["winter","spring","summer","autom"];console.info("setSeason : "+a[season]);$("#nature").css("backgroundImage","url(weather/img/"+a[season]+".png)")}function init(a){WEB_URL=isDefined(a.node_url)?a.node_url:"http://192.168.1.199";CHIP=isDefined(a.chip_weather)?parseInt(a.chip_weather):772471;DEBUG=false;start_day=parseInt(a.start_day)||6;start_night=parseInt(a.start_night)||19;swap_frequency=parseInt(a.swap_frequenc)||2;auto_start_night_mode=a.auto_start_night_mode||false;sendRequestToNativeApp(EVT_WEATHER,{response:null});window.setTimeout(function(){sendRequestToNativeApp(EVT_SYNC,{response:null})},5000);setInterval(function(){sendRequestToNativeApp(EVT_WEATHER,{response:null})},3600000);getWeatherOutDoor();DateTime();updateUI()}function updateUI(){setSeason();setEnvironment()}function clickRunSeasonScript(a){a.stopPropagation();runSeasonScript()}function runSeasonScript(){fast_time=!fast_time;$("#cur_date").toggleClass("select",fast_time);if(fast_time){curMonth=0;seasonTimer=setInterval(seasonScript,6000)}else{clearInterval(seasonTimer);DateTime()}}function seasonScript(){tod_visual++;if(tod_visual>3){tod_visual=0;cloudiness++;if(cloudiness==2&&curMonth==0){precipitation=6;snow=true}if(cloudiness==2&&curMonth==1){precipitation=7;snow=true}if(cloudiness==2&&curMonth==4){thunderstorm=true;precipitation=8}if(cloudiness>3){cloudiness=-1;precipitation=0;curMonth++;if(curMonth>11){curMonth=0}setCurrentSeason(curMonth)}}$("#cur_date").html(MONTH[curMonth]+" • "+TODS[tod_visual]);console.info("seasonScript : "+MONTH[curMonth],TODS[tod_visual],cloudiness);updateUI()}function getPrecipitationIcon(a){var b="";var c=a.PHENOMENA.precipitation||10;switch(c){case 3:b="snow_with_rain";break;case 4:b="rain1";break;case 5:b="rain2";break;case 6:b="snow1";break;case 7:b="snow2";break}return b}function getCloudIcon(b){var c="";var e=b.PHENOMENA.cloudiness;var a=precipitation===8||b.PHENOMENA.spower===1||false;var d=precipitation===4||precipitation===5||false;if(a){c=d?"thunderstorm_rain":"thunderstorm"}else{switch(e){case -1:c="cloud_fog";break;case 0:c="none";break;case 1:c="cloud1";break;case 2:c="cloud2";break;case 3:c="cloud3";break}}return c}function forecastItem(a){if(a==null){return}var d=Math.round((a.TEMPERATURE.min+a.TEMPERATURE.max)*0.5);var f=d<0?"minus":"plus";var e=a.tod===0||a.tod===3?"/night/":"/day/";var c=a.PHENOMENA.cloudiness===3?"none":"url(weather/img"+e+"star.png);";var b='<div class="forecast_item" style="background-image: '+c+'"><div class="i_data"><div><span>'+a.day+", "+MONTH[Number(a.month)-1]+"•"+a.year+"</span></div>• "+TODS[a.tod]+' •</div><div class="i_cloud" style="background-image: url(weather/img'+e+getCloudIcon(a)+'.png);"><div class="i_precipitation" style="background-image: url(weather/img/precipitation/'+getPrecipitationIcon(a)+'.png);"><span class="'+f+'">'+(d>0?"+":"")+d+'°C</span></div></div><div class="desc_item"><span class="ic pressure">Presure • '+a.PRESSURE.max+' mmHq</span><span class="ic humidity">Humidity • '+a.RELWET.min+"-"+a.RELWET.max+' %</span><span class="ic wind">Wind • '+a.WIND.min+"-"+a.WIND.max+' m/s</span><span class="ic heat">Heat • '+a.HEAT.min+"°C</span></div></div>";return b}function createForecast(b){var c="";for(var a=0;a<b.length;a++){c=c+forecastItem(b[a])}$("#forecast").html('<div class="forecast_title">Daily weather forecast for Kharkiv • Ukraine</div>'+c)}function clickToggleForecast(a){a.stopPropagation();toggleForecast()}function toggleForecast(){if($("#forecast").hasClass("show")){$("#forecast").toggleClass("show",false);$(".content_box").toggleClass("hide",false)}else{$(".content_box").toggleClass("hide",true);$("#forecast").toggleClass("show",true);sendRequestToNativeApp(EVT_WEATHER,{response:null})}};